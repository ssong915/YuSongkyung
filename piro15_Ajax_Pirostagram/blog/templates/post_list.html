{% extends 'base.html'%}

{%block content%}
    {%for post in posts%}  
        <div class="post_{{post.id}}" style="border: 1px solid lightgray; border-radius: 20px; margin: 50px; padding: 20px">
            <div class="row" style="justify-content: space-evenly; align-items: center;">
                <div class="col-4"> 
                    {% if post.image %} <!--ì‚¬ì§„-->
                    <p><img src="{{post.image.url}}" style="width: 450px;" ></p>
                    {% else %}
                    <p></p>
                    {% endif %}
                </div>
                <div class="col-4"> 
                    <h5>{{ post.title }}</h5> <!--ì œëª©-->
                    <hr>
                    
                    <div style="height: 100px;">
                        <p>{{ post.content }}</p> <!--ë‚´ìš©-->
                    </div>
                    
                    <div><!--ì¢‹ì•„ìš”-->
                        {% if post.like == 0 %} 
                        <div class="like" onclick="onClickLike({{ post.id }},{{ post.like }})">
                            ğŸ¤ ê²Œì‹œë¬¼ì´ ë§ˆìŒì— ë“ ë‹¤ë©´ ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!
                        </div>
                        
                        {% else %}
                        <div class="like" onclick="onClickLike({{ post.id }},{{ post.like }})">
                            â¤ï¸ ì´ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!
                        </div>
                        
                        {% endif %}
                        <hr style="margin-bottom:8px;">
                    </div>
                    
                        <p style="margin:0;">ëŒ“ê¸€</p>
                        <hr style="margin-top:8px;">
                    <div class="comment_{{ post.id }}"> <!--ëŒ“ê¸€ ì‚­ì œ-->
                        {% for comment in comments %}
                            {% if comment.post == post %}
                            <div class="comment-id-{{ comment.id }}" style="margin: 10px ;">
                                {{ comment.comment }}
                                <button class="btn btn-primary btn-sm" onclick="onClickDelete({{comment.id}})" style="float: right;">ì‚­ì œ</button>
                            </div>
                            
                            {% endif %}
                        {% endfor %}    
                    </div>   
                    <hr>
                    <!--ëŒ“ê¸€ ë‹¬ê¸°-->    
                    <input class="create-comment" type="text" placeholder="ëŒ“ê¸€">
                    <button class="btn btn-primary btn-sm" onclick="onClickCreate({{ post.id }})">ê²Œì‹œ</button>
                    
                    <hr>
                </div>
                
            </div>
            


        </div>
    {%endfor%}
{%endblock%}

{% block extra %}
<script>
    //ì¢‹ì•„ìš”
   const requestLike=new XMLHttpRequest();

    const onClickLike=(id,like)=>{
        const url='/like_ajax/';
        requestLike.open('POST',url,true);
        requestLike.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestLike.send(JSON.stringify({id:id,like:like}));
    };

    const likeHandleResponse=()=>{
        if(requestLike.status<400){
            const {id}=JSON.parse(requestLike.response);
            const element=document.querySelector(`.post_${id} .like`);

            if(element.innerHTML=='â¤ï¸ ì´ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!'){
                element.innerHTML='ğŸ¤ ê²Œì‹œë¬¼ì´ ë§ˆìŒì— ë“ ë‹¤ë©´ ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!';
            }
            else{
                element.innerHTML='â¤ï¸ ì´ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!';
            }

        }
    }
    requestLike.onreadystatechange=()=>{
        if(requestLike.readyState===XMLHttpRequest.DONE){
            likeHandleResponse();
        }
    }

    //ëŒ“ê¸€ ë“±ë¡
    const requestComment=new XMLHttpRequest();

    const onClickCreate=(id)=>{
        const url='/create_ajax/';
        requestComment.open('POST',url,true);
        requestComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        
        const comment=document.querySelector(`.post_${id} .create-comment`).value
        requestComment.send(JSON.stringify({id:id,comment:comment}));
    };
    
    const CreateHandleResponse=()=>{
        if(requestComment.status<400){
            const {post_id}=JSON.parse(requestComment.response);
            const {comment_id}=JSON.parse(requestComment.response);
            const {comment}=JSON.parse(requestComment.response);
            const element=document.querySelector(`.post_${post_id} .comment_${ post_id }`);
            element.innerHTML=`  
            <div class="comment-id-${ comment.id }">
                ${comment}
                <button class="btn btn-primary btn-sm" onclick="onClickDelete(${comment.id})">ì‚­ì œ</button>
            </div>
            <hr> `;
        }
    }
    requestLike.onreadystatechange=()=>{
        if(requestLike.readyState===XMLHttpRequest.DONE){
            likeHandleResponse();
        }
    }
    //ëŒ“ê¸€ ì‚­ì œ
    const requestDelete = new XMLHttpRequest();

    const onClickDelete = (id) => {
        const url = '/delete_ajax/';
        requestDelete.open('POST', url, true);
        requestDelete.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestDelete.send(JSON.stringify({id: id}));
    };

    const deleteHandleResponse = () => {
        if (requestLike.status < 400) {
            const {id} = JSON.parse(requestDelete.response); 
            const element = document.querySelector(`.comment-id-${id}`);
            element.innerHTML = "";
        };
    };

    requestDelete.onreadystatechange = () => {
        if (requestDelete.readyState === XMLHttpRequest.DONE) {
            deleteHandleResponse();
        };
    };

</script> 
{%endblock%}